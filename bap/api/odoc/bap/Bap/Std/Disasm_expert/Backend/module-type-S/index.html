<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>S (bap.Bap.Std.Disasm_expert.Backend.S)</title><link rel="stylesheet" href="../../../../../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../../index.html">bap</a> &#x00BB; <a href="../../../../index.html">Bap</a> &#x00BB; <a href="../../../index.html">Std</a> &#x00BB; <a href="../../index.html">Disasm_expert</a> &#x00BB; <a href="../index.html">Backend</a> &#x00BB; S</nav><header class="odoc-preamble"><h1>Module type <code><span>Backend.S</span></code></h1><p>The backend interface.</p><p>The backend is a simple automaton that disassembles instructions and pushes them into the queue. It runs until it either hits an instruction that matches with one of the previously set predicates or if it either hits an invalid instruction or runs out of the bounds of the specified memory region. On the high level the algorithm of the <code>run</code> function can be described with the following pseudocode.</p><p>1. disassemble instruction 2. push result into the queue 3. update the offset 4. if exists predicate p such that p(insn) or off &gt;= length(data) then stop else goto 1.</p><p>If it is impossible to decode the given sequence of bytes, then an invalid instruction is pushed into the queue and disassembling continues on the next offset.</p><p>Predicates enables fine control over the behavior of the disassembler. For example, the <code>Is_true</code> predicate is always <code>true</code> disassembler will stop after each instruction. The backend is not required to support all predicates, only <code>Is_true</code> and <code>Is_invalid</code> are required.</p><p>The state of the disassembler includes the queue of disassembled instructions, the last disassembled instruction, the set of predicates, and the current offset. At the beginning, the queue and the set of predicates are empty, the offset is zero, and the last disassembled instruction is invalid.</p><p>To minimize allocations, opcodes and register names are represented as offsets in the corresponding string tables.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>an abs</p></div></div><div class="odoc-spec"><div class="spec value" id="val-delete" class="anchored"><a href="#val-delete" class="anchor"></a><code><span><span class="keyword">val</span> delete : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>delete d</code> is called when the disassembler is no longer needed.</p><p>It is safe now to free any data related with the disassembler.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-set_memory" class="anchored"><a href="#val-set_memory" class="anchor"></a><code><span><span class="keyword">val</span> set_memory : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int64 <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Core_kernel</span>.Bigstring.t <span class="arrow">&#45;&gt;</span></span> <span>off:int <span class="arrow">&#45;&gt;</span></span> <span>len:int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_memory dis addr data ~off ~len</code> sets the current memory region.</p><p>Sets the memory region accessible by disassembler to a substring of <code>data</code> starting at the offset <code>off</code> and having the length <code>len</code> with the first byte at <code>off</code> having the address <code>addr</code>.</p><p>Parameters <code>off</code> and <code>len</code> must be non-negative numbers. The <code>offset dis</code> shall be equal to <code>0</code> after this function is executed.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-store_predicates" class="anchored"><a href="#val-store_predicates" class="anchor"></a><code><span><span class="keyword">val</span> store_predicates : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>store_predicates dis on_off</code> turns predicate storage on or off.</p><p>When it is <code>off</code> it is not required to store semantic predicates for each instruction in the queue, only for the last disassembled one. It is <code>off</code> by default.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-store_asm_string" class="anchored"><a href="#val-store_asm_string" class="anchor"></a><code><span><span class="keyword">val</span> store_asm_string : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>store_asm_string dis on_off</code> turns assembly string storage on or off.</p><p>When it is <code>off</code> it is not required to store assembly strings for each instruction in the queue, only for the last disassembled one.</p><p>It is <code>off</code> by default.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_table" class="anchored"><a href="#val-insn_table" class="anchor"></a><code><span><span class="keyword">val</span> insn_table : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Core_kernel</span>.Bigstring.t</span></code></div><div class="spec-doc"><p><code>insn_table dis</code> returns a string table for opcodes.</p><p>The table contains a sequence of null-terminated strings.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-reg_table" class="anchored"><a href="#val-reg_table" class="anchor"></a><code><span><span class="keyword">val</span> reg_table : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Core_kernel</span>.Bigstring.t</span></code></div><div class="spec-doc"><p><code>reg_table dis</code> returns a string table for register names.</p><p>The table contains a sequence of null-terminated strings.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-predicates_clear" class="anchored"><a href="#val-predicates_clear" class="anchor"></a><code><span><span class="keyword">val</span> predicates_clear : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>predicates_clear dis</code> clears the set of predicates.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-predicates_push" class="anchored"><a href="#val-predicates_push" class="anchor"></a><code><span><span class="keyword">val</span> predicates_push : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../index.html#type-predicate">predicate</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>predicates_push dis p</code> adds <code>p</code> to the set of predicates.</p><p>precondition: <code>is_supported dis p</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-is_supported" class="anchored"><a href="#val-is_supported" class="anchor"></a><code><span><span class="keyword">val</span> is_supported : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../index.html#type-predicate">predicate</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_supported dis p</code> is <code>true</code> if <code>dis</code> supports <code>p</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-set_offset" class="anchored"><a href="#val-set_offset" class="anchor"></a><code><span><span class="keyword">val</span> set_offset : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_offset dis off</code> sets the current offset to <code>off</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-offset" class="anchored"><a href="#val-offset" class="anchor"></a><code><span><span class="keyword">val</span> offset : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>offset dis</code> is the current offset.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-run" class="anchored"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>run dis</code> runs the disassembler.</p><p>The disassembler runs until it hits an instruction that matches one of the predicates in the disassemblers current set of predicates or it runs out of the boundaries of the currently specified memory region.</p><p>See the module description for the more detailed description of the backend algorithm.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insns_clear" class="anchored"><a href="#val-insns_clear" class="anchor"></a><code><span><span class="keyword">val</span> insns_clear : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>insns_clear dis</code> clears the disassembler instructions queue.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insns_size" class="anchored"><a href="#val-insns_size" class="anchor"></a><code><span><span class="keyword">val</span> insns_size : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insns_size dis</code> the length of the instruction queue.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_size" class="anchored"><a href="#val-insn_size" class="anchor"></a><code><span><span class="keyword">val</span> insn_size : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insn_size dis ~insn:n</code> the <code>n</code>th instruction length.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_name" class="anchored"><a href="#val-insn_name" class="anchor"></a><code><span><span class="keyword">val</span> insn_name : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insn_name dis ~insn:n</code> the <code>n</code>th instruction name.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_code" class="anchored"><a href="#val-insn_code" class="anchor"></a><code><span><span class="keyword">val</span> insn_code : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insn_name dis ~insn:n</code> the <code>n</code>th instruction opcode.</p><p>The opcode name is represented as an offset to the <code>insn_table dis</code> string table in which each element is a null-terminated string.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_offset" class="anchored"><a href="#val-insn_offset" class="anchor"></a><code><span><span class="keyword">val</span> insn_offset : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insn_offset dis ~insn:n</code> the offset of <code>n</code>th instruction.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_asm_size" class="anchored"><a href="#val-insn_asm_size" class="anchor"></a><code><span><span class="keyword">val</span> insn_asm_size : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insn_offset dis ~insn:n</code> the <code>n</code>th instruction assembly string length.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_asm_copy" class="anchored"><a href="#val-insn_asm_copy" class="anchor"></a><code><span><span class="keyword">val</span> insn_asm_copy : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../../../regular/Regular/Std/Bytes/index.html#type-t">Regular.Std.Bytes.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>insn_asm_copy dis ~insn:n data</code> copies the assembly string of the <code>n</code>th instruction.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_satisfies" class="anchored"><a href="#val-insn_satisfies" class="anchor"></a><code><span><span class="keyword">val</span> insn_satisfies : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> <span><a href="../index.html#type-predicate">predicate</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>insn_satisfies dis ~insn:n p</code> is <code>true</code> if the <code>n</code>th instruction satisfies the predicate <code>p</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_ops_size" class="anchored"><a href="#val-insn_ops_size" class="anchor"></a><code><span><span class="keyword">val</span> insn_ops_size : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insn_ops_size dis ~insn:n</code> the number of operands.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_op_type" class="anchored"><a href="#val-insn_op_type" class="anchor"></a><code><span><span class="keyword">val</span> insn_op_type : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> <span>oper:int <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-op">op</a></span></code></div><div class="spec-doc"><p><code>insn_op_type dis ~insn:n ~oper:m</code> the <code>m</code>th operand type.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_op_reg_name" class="anchored"><a href="#val-insn_op_reg_name" class="anchor"></a><code><span><span class="keyword">val</span> insn_op_reg_name : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> <span>oper:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insn_op_reg_name dis ~insn:n ~oper:m</code> the register name.</p><p>Returns the register name of the operand <code>m</code>. The name is represented as an offset to the <code>reg_table dis</code>, which is a string table of null-terminated strings.</p><p>Precondition: <code>insn_op_type dis ~insn:n ~oper:m = Reg</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_op_reg_code" class="anchored"><a href="#val-insn_op_reg_code" class="anchor"></a><code><span><span class="keyword">val</span> insn_op_reg_code : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> <span>oper:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insn_op_reg_name dis ~insn:n ~oper:m</code> the register code.</p><p>Returns the register code of the operand <code>m</code>. The code is a unique number identifying the register (could be the same as <code>insn_op_reg_name</code>.</p><p>Precondition: <code>insn_op_type dis ~insn:n ~oper:m = Reg</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_op_imm_value" class="anchored"><a href="#val-insn_op_imm_value" class="anchor"></a><code><span><span class="keyword">val</span> insn_op_imm_value : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> <span>oper:int <span class="arrow">&#45;&gt;</span></span> int64</span></code></div><div class="spec-doc"><p><code>insn_op_imm_value dis ~insn:n ~oper:m</code> the immediate value.</p><p>Returns the value of the operand <code>m</code>.</p><p>Precondition: <code>insn_op_type dis ~insn:n ~oper:m = Imm</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_op_imm_small_value" class="anchored"><a href="#val-insn_op_imm_small_value" class="anchor"></a><code><span><span class="keyword">val</span> insn_op_imm_small_value : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> <span>oper:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>insn_op_imm_small_value dis ~insn:n ~oper:m</code> the immediate value.</p><p>If the value <code>v</code> of the operand <code>m</code> is strictly greater than <code>Int.min_val</code> and is strictly less than <code>Int.max_val</code> then returns <code>v</code> otherwise returns <code>Int.min_val</code> or <code>Int.max_val</code>.</p><p>Precondition: <code>insn_op_type dis ~insn:n ~oper:m = Imm</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-insn_op_fmm_value" class="anchored"><a href="#val-insn_op_fmm_value" class="anchor"></a><code><span><span class="keyword">val</span> insn_op_fmm_value : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>insn:int <span class="arrow">&#45;&gt;</span></span> <span>oper:int <span class="arrow">&#45;&gt;</span></span> float</span></code></div><div class="spec-doc"><p><code>insn_op_fmm_value</code> the floating-point immediate value.</p><p>Returns the value of the operand <code>m</code>.</p><p>Precondition: <code>insn_op_type dis ~insn:n ~oper:m = Fmm</code></p></div></div></div></body></html>