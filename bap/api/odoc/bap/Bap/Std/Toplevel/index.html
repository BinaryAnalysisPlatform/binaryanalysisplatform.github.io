<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Toplevel (bap.Bap.Std.Toplevel)</title><link rel="stylesheet" href="../../../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../../index.html">bap</a> &#x00BB; <a href="../../index.html">Bap</a> &#x00BB; <a href="../index.html">Std</a> &#x00BB; Toplevel</nav><header class="odoc-preamble"><h1>Module <code><span>Std.Toplevel</span></code></h1><p>The interface to the BAP toplevel state.</p><p>To create a project from the binary code BAP relies on the knowledge base, which is a state monad underneath the hood, or, put it simply, each knowledge computation is a function of type <code>state -&gt; state * 'a</code>. To enable backward compatibility, we compute each such stateful computation in the toplevel, which also stores the hidden state.</p><p>Using this interface it is possible to evaluate knowledge base computations and extract their results to concrete values. Since the knowledge base computations are not expression but objective language, i.e., they evaluate to knowledge base objects, not to values, we commonly need to create objects that will carry the result of the computation as their properties. To ease the process this module provides the notion of toplevel variables, that denote such properties. Here is an example, how to run a knowledge base computation and extract its result, assuming that <code>analysis</code> is a function of type <code>unit -&gt; my knowledge</code></p><pre><code>let result : my var = Toplevel.var &quot;my-property&quot;
let run analysis : my =
  Toplevel.put result (analysis ());
  Toplevel.get result</code></pre><p>There are also <code>eval</code> and <code>exec</code> functions that could be used to extract values from the existing properties, e.g.,</p><pre><code>let get_unit tid =
  eval Theory.Label.unit (KB.return tid)</code></pre><p>Finally, the interface provides functions to control the inner state of the toplevel, which is the knowledge base that is used by BAP throught the lifetime of the BAP process and could be also persistet between runs. E.g., the <code>disassemble</code> plugin is persisting the knowledge base in the BAP cache facility and loads it when it identifies that the input digest is the same.</p><p>Warning: this interface should be used with care, in particular, it shall not be used in the context of another knowledge computation that is also run in the toplevel.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 2.2.0 made public and documented, the state interface</li></ul><p>was available since 2.0.0 but wasn't documented and considered official.</p></header><nav class="odoc-toc"><ul><li><a href="#toplevel-variables">Toplevel variables</a></li><li><a href="#the-slot-interface">The slot interface</a></li><li><a href="#the-state-interface">The state interface</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec exception" id="exception-Conflict" class="anchored"><a href="#exception-Conflict" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Conflict</span> <span class="keyword">of</span> <a href="../../../../bap-knowledge/Bap_knowledge/Knowledge/index.html#type-conflict">Bap_knowledge.Knowledge.conflict</a></span></code></div><div class="spec-doc"><p>this exception is raised when the knowledge computation enters the inconsistent state.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 2.2.0</li></ul></div></div><h4 id="toplevel-variables"><a href="#toplevel-variables" class="anchor"></a>Toplevel variables</h4><div class="odoc-spec"><div class="spec type" id="type-var" class="anchored"><a href="#type-var" class="anchor"></a><code><span><span class="keyword">type</span> <span>'p var</span></span></code></div><div class="spec-doc"><p>the type of variables holding property <code>'p</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-var" class="anchored"><a href="#val-var" class="anchor"></a><code><span><span class="keyword">val</span> var : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'p</span> <a href="#type-var">var</a></span></span></code></div><div class="spec-doc"><p><code>var name</code> creates a fresh variable.</p><p>Creates and declares a fresh new property of the <code>bap:toplevel</code> class. The name is mangled to prevent clashing with existing properties, and each evaluation of this function creates a new property that is distinct from any previously created properties.</p><p>Warning: this function changes the static representation of the knowledge base (the scheme) and should be only used to create static (global) variables, that have the lifetime of the BAP process. It is not recommended to call this function inside any other function.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-put" class="anchored"><a href="#val-put" class="anchor"></a><code><span><span class="keyword">val</span> put : <span><span><span class="type-var">'p</span> <a href="#type-var">var</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'p</span> <a href="../../../../bap-knowledge/Bap_knowledge/index.html#type-knowledge">Bap_knowledge.knowledge</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>put var exp</code> evaluates <code>exp</code> and sets <code>var</code> to its result.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Conflict</span> <p>if <code>exp</code> ends up in the conflicting state.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-get" class="anchored"><a href="#val-get" class="anchor"></a><code><span><span class="keyword">val</span> get : <span><span><span class="type-var">'p</span> <a href="#type-var">var</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'p</span></span></code></div><div class="spec-doc"><p><code>get var</code> reads the value of the variable.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Not_found</span> <p>if <code>var</code> was not set with <code>put</code>.</p></li></ul></div></div><h4 id="the-slot-interface"><a href="#the-slot-interface" class="anchor"></a>The slot interface</h4><div class="odoc-spec"><div class="spec value" id="val-eval" class="anchored"><a href="#val-eval" class="anchor"></a><code><span><span class="keyword">val</span> eval : <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'p</span>)</span> <a href="../../../../bap-knowledge/Bap_knowledge/Knowledge/index.html#type-slot">Bap_knowledge.Knowledge.slot</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span><span class="type-var">'a</span> <a href="../../../../bap-knowledge/Bap_knowledge/Knowledge/index.html#type-obj">Bap_knowledge.Knowledge.obj</a></span> <a href="../../../../bap-knowledge/Bap_knowledge/index.html#type-knowledge">Bap_knowledge.knowledge</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'p</span></span></code></div><div class="spec-doc"><p><code>eval property obj_exp</code> gets <code>property</code> of <code>obj_exp</code>.</p><p>Evaluates the computation <code>obj_exp</code> that shall return an object of class <code>'a</code> and returns the value <code>'p</code> of the specified <code>property</code>.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Conflict</span> <p>when the knowledge base enters the conflicting state.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-try_eval" class="anchored"><a href="#val-try_eval" class="anchor"></a><code><span><span class="keyword">val</span> try_eval : <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'p</span>)</span> <a href="../../../../bap-knowledge/Bap_knowledge/Knowledge/index.html#type-slot">Bap_knowledge.Knowledge.slot</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span><span class="type-var">'a</span> <a href="../../../../bap-knowledge/Bap_knowledge/Knowledge/index.html#type-obj">Bap_knowledge.Knowledge.obj</a></span> <a href="../../../../bap-knowledge/Bap_knowledge/index.html#type-knowledge">Bap_knowledge.knowledge</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'p</span>, <a href="../../../../bap-knowledge/Bap_knowledge/Knowledge/index.html#type-conflict">Bap_knowledge.Knowledge.conflict</a>)</span> <span class="xref-unresolved">Core_kernel</span>.result</span></span></code></div><div class="spec-doc"><p><code>try_eval property object</code> is like <code>eval property object</code> but returns <code>Error conflict</code> instead of raising an exception.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-exec" class="anchored"><a href="#val-exec" class="anchor"></a><code><span><span class="keyword">val</span> exec : <span><span>unit <a href="../../../../bap-knowledge/Bap_knowledge/index.html#type-knowledge">Bap_knowledge.knowledge</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>exec stmt</code> executes the side-effectful knowledge computation.</p><p>Executes the statement and updates the internal knowledge base.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Conflict</span> <p>when the knowledge base enters the conflicting state.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-try_exec" class="anchored"><a href="#val-try_exec" class="anchor"></a><code><span><span class="keyword">val</span> try_exec : <span><span>unit <a href="../../../../bap-knowledge/Bap_knowledge/index.html#type-knowledge">Bap_knowledge.knowledge</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <a href="../../../../bap-knowledge/Bap_knowledge/Knowledge/index.html#type-conflict">Bap_knowledge.Knowledge.conflict</a>)</span> <span class="xref-unresolved">Core_kernel</span>.result</span></span></code></div><div class="spec-doc"><p><code>try_exec stmt</code> is like <code>exec stmt</code> but returns <code>Error conflict</code> instead of raising an exception.</p></div></div><h4 id="the-state-interface"><a href="#the-state-interface" class="anchor"></a>The state interface</h4><div class="odoc-spec"><div class="spec value" id="val-set" class="anchored"><a href="#val-set" class="anchor"></a><code><span><span class="keyword">val</span> set : <span><a href="../../../../bap-knowledge/Bap_knowledge/Knowledge/index.html#type-state">Bap_knowledge.Knowledge.state</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set s</code> sets the knowledge base state to <code>s</code>.</p><p>Any existing state is discarded.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-current" class="anchored"><a href="#val-current" class="anchor"></a><code><span><span class="keyword">val</span> current : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../../../../bap-knowledge/Bap_knowledge/Knowledge/index.html#type-state">Bap_knowledge.Knowledge.state</a></span></code></div><div class="spec-doc"><p><code>current ()</code> is the current state of the knowledge base.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-reset" class="anchored"><a href="#val-reset" class="anchor"></a><code><span><span class="keyword">val</span> reset : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>reset ()</code> resets the knowledge state to the empty state.</p><p>It is the same as <code>set @@ KB.empty</code></p></div></div></div></body></html>